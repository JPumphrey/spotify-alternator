<!DOCTYPE html>
<html>
<head>
  <title>Spotify Controller</title>
</head>
<body>
  <h1>Spotify Controller</h1>

  <script src="token.js"></script>
  <script>
    function create_playlist() {
        var playlist_uri = document.getElementById("playlist_uri").value
        var song_uri = document.getElementById("song_uri").value 

        var playlist_id = playlist_uri.replace("spotify:playlist:", "")

        fetch(`https://api.spotify.com/v1/playlists/${playlist_id}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        }).then(response => {
            return response.json()
        }).then(data => {
            console.log(data.id)
            return data
        }).then(playlist => {
            fetch(`https://api.spotify.com/v1/playlists/${playlist_id}/tracks`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            }).then(response => {
                return response.json()
            }).then(data => {
                var new_tracks = []
                for(var i = 0; i < data.items.length; i++) {
                    // not sure why tracks are sometimes null
                    if (data.items[i].track != null) {
                        new_tracks.push(song_uri);
                        new_tracks.push(data.items[i].track.uri)
                    }
                }

                return new_tracks
            }).then(new_tracks => {
                fetch(`https://api.spotify.com/v1/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                }).then(response => {
                    return response.json()
                }).then(data => {
                    console.log("user id: " + data.id)
                    return data.id
                }).then(user_id => {
                    fetch(`https://api.spotify.com/v1/users/${user_id}/playlists`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: playlist.name + "--mix",
                            public: false
                        })
                    }).then(response => {
                        return response.json()
                    }).then(data => {
                        return data
                    }).then(new_playlist => {
                        fetch(`https://api.spotify.com/v1/playlists/${new_playlist.id}/tracks`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                uris: new_tracks.slice(0, 100)
                            })
                        }).then(response => {
                            return response.json()
                        }).then(data => {
                            console.log(data)
                            return data
                        })
                    })
                })
            });
        });
    }
  </script>

<form id="form">
        Song uri: <input type="text" id="song_uri" value="><br/>
        Playlist uri: <input type="text" id="playlist_uri" value=""><br/>
        <input type="button" onclick="create_playlist()" value="Create playlist">
</form>
</body>
</html>